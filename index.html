<!doctype html>
<html>
<body>
<script>
const base64 = (function(){
  var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

  // Use a lookup table to find the index.
  var lookup = new Uint8Array(256);
  for (var i = 0; i < chars.length; i++) {
    lookup[chars.charCodeAt(i)] = i;
  }

  function encode(arraybuffer) {
    var bytes = new Uint8Array(arraybuffer),
    i, len = bytes.length, base64 = "";

    for (i = 0; i < len; i+=3) {
      base64 += chars[bytes[i] >> 2];
      base64 += chars[((bytes[i] & 3) << 4) | (bytes[i + 1] >> 4)];
      base64 += chars[((bytes[i + 1] & 15) << 2) | (bytes[i + 2] >> 6)];
      base64 += chars[bytes[i + 2] & 63];
    }

    if ((len % 3) === 2) {
      base64 = base64.substring(0, base64.length - 1) + "=";
    } else if (len % 3 === 1) {
      base64 = base64.substring(0, base64.length - 2) + "==";
    }

    return base64;
  }
  function decode(base64) {
    var bufferLength = base64.length * 0.75,
    len = base64.length, i, p = 0,
    encoded1, encoded2, encoded3, encoded4;

    if (base64[base64.length - 1] === "=") {
      bufferLength--;
      if (base64[base64.length - 2] === "=") {
        bufferLength--;
      }
    }

    var arraybuffer = new ArrayBuffer(bufferLength),
    bytes = new Uint8Array(arraybuffer);

    for (i = 0; i < len; i+=4) {
      encoded1 = lookup[base64.charCodeAt(i)];
      encoded2 = lookup[base64.charCodeAt(i+1)];
      encoded3 = lookup[base64.charCodeAt(i+2)];
      encoded4 = lookup[base64.charCodeAt(i+3)];

      bytes[p++] = (encoded1 << 2) | (encoded2 >> 4);
      bytes[p++] = ((encoded2 & 15) << 4) | (encoded3 >> 2);
      bytes[p++] = ((encoded3 & 3) << 6) | (encoded4 & 63);
    }

    return arraybuffer;
  }
  return {
    encode,
    decode,
  };
})();

window.addEventListener('message', async e => {
  let error, result, port;
  try {
    const {data} = e;
    // console.log('got message', data);
    const {htmlString, width, height} = data;
    port = data.port;

    if (htmlString && isFinite(width) && isFinite(height) && port) {
      const dom = new DOMParser().parseFromString(htmlString, 'text/html');
      const {head, body} = dom;
      const html = body.parentNode;
      // console.log('got dom', html);

      const styles = [];
      Array.from(html.querySelectorAll('style')).forEach(style => {
        styles.push(style.textContent);
      });
      await Promise.all(Array.from(html.querySelectorAll('link')).map(link => new Promise((accept, reject) => {
        if (link.rel === 'stylesheet' && link.href) {
          fetch(link.href)
            .then(res => {
              if (res.status >= 200 && res.status < 300) {
                return res.text();
              } else {
                return Promise.reject(new Error(`invalid status code: ${res.status}`));
              }
            })
            .then(async s => {
              const regex = /(url\()([^\)]+)(\))/g;
              let match;
              while (match = regex.exec(s)) {
                const res = await fetch(match[2]);
                if (res.status >= 200 && res.status < 300) {
                  const arraybuffer = await res.arrayBuffer();
                  const b64 = base64.encode(arraybuffer);
                  const inner = match[1] + '"data:font/woff;charset=utf-8;base64,' + b64 + '"' + match[3];
                  s = s.slice(0, match.index) + inner + s.slice(match.index + match[0].length);
                  regex.lastIndex = match.index + inner.length;
                } else {
                  return Promise.reject(new Error(`invalid status code: ${res.status}`));
                }
              }

              // console.log('got style text', s);
              // const style = document.createElement('style');
              // style.textContent = s;
              // console.log('got style', style);
              styles.push(s);
            })
            .then(accept)
            .catch(err => {
              console.warn(err);
              accept();
            });
        } else {
          accept();
        }
      })));

      Array.from(html.querySelectorAll('script')).forEach(script => {
        script.parentNode.removeChild(script);
      });

      // console.log('got 2');

      await Promise.all(Array.from(html.querySelectorAll('img')).map(img => new Promise((accept, reject) => {
        if (img.src) {
          img.onload = accept;
          img.onerror = err => {
            console.warn(err);
            accept();
          };
        } else {
          accept();
        }
      })));

      // console.log('got 3');

      const o = await new Promise((accept, reject) => {
        const start = Date.now();

        const img = new Image();
        img.src = ('data:image/svg+xml;charset=utf-8,' +
          '<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'' + width + '\' height=\'' + height + '\'>' +
            styles.map(style => '<style>' + style.replace(/#/g, '%23') + '</style>').join('') +
            '<foreignObject width=\'100%\' height=\'100%\' x=\'0\' y=\'0\' style=\'background-color: white;\'>' +
              /* '<style>' +
                'x-row { display: block; }' +
                'x-row:empty::before { content: \' \'; }' +
              '</style>' + */
              // new XMLSerializer().serializeToString(head) +
              // '<head><style>lol{}\n</style></head>' +
              new XMLSerializer().serializeToString(body) +
              // src.replace(/^<body/, '<div').replace(/<\/body>$/, '</div>') +
            '</foreignObject>' +
          '</svg>'
        )// .replace(/\n/g, '');
        console.log('got src', img.src);
        img.crossOrigin = 'Anonymous';
        img.onload = () => {
          console.log('got img time', Date.now() - start);

          /* const canvas = document.createElement('canvas');
          canvas.width = img.naturalWidth;
          canvas.height = img.naturalHeight;
          const ctx = canvas.getContext('2d');
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const {width, height, data} = imageData;
          accept([null, {width, height, data}]); */

          createImageBitmap(img).then(imageBitmap => {
            // console.log('got image bitmap', imageBitmap.width, imageBitmap.height);
            accept([null, imageBitmap]);
          });
        };
        img.onerror = err => {
          console.warn('img error', err);
          accept([err.stack, null]);
        };
      });

      // console.log('got 4', !!error, !!result);

      error = o[0];
      result = o[1];
    }
  } catch (err) {
    error = err.stack;
  }

  if (error || result) {
    // window.parent.postMessage({error, result}, '*', result ? [result] : []);
    // port.postMessage({error, result, result2: src}, [result]);
    port.postMessage({error, result/*, result2: src*/});
  }
});

/* window.onload = () => {
  const _recurse = () => {
    console.log('start work');
    let start = Date.now();
    for (;;) {
      if ((Date.now() - start) < 3000) {
        const div = document.createElement('div');
        document.body.appendChild(div);
        document.body.removeChild(div);
      } else {
        break;
      }
    }
    setTimeout(_recurse, 1000);
    console.log('end work');
  };
  _recurse();
}; */
</script>
</body>
</html>
